// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
    // Further reading:
    // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
    // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
    url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  refresh_token_expires_in Int? // Specific to some providers like Keycloak

  @@unique([provider, providerAccountId])
  @@index([userId]) // Added for faster lookups by userId
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId]) // Added for faster lookups by userId
}

model User {
  id            String    @id @default(cuid()) // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (CUIDã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«)
  name          String?   // ãƒ¦ãƒ¼ã‚¶ãƒ¼å (NextAuth.jsæ¨™æº–)
  email         String    @unique // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„)
  emailVerified DateTime? // ãƒ¡ãƒ¼ãƒ«èªè¨¼æ—¥æ™‚ (NextAuth.jsæ¨™æº–)
  image         String?   // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®URL (NextAuth.jsæ¨™æº–)
  
  // è¿½åŠ ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  pwHash        String?   // ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (èªè¨¼ç”¨)
  createdAt     DateTime  @default(now()) // ä½œæˆæ—¥æ™‚
  updatedAt     DateTime  @updatedAt // æ›´æ–°æ—¥æ™‚

  // NextAuth.jsã§å¿…è¦ãªãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  accounts      Account[] // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ± (1å¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
  sessions      Session[] // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ± (1å¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)

  profile       Profile?  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« (1å¯¾1ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
  stories       Story[]   // ä½œæˆã—ãŸè‡ªåˆ†å²ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ (1å¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
  family        Family?   // ç™ºè¡Œã—ãŸå®¶æ—ID (1å¯¾1ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
  sentFamilyRequests    FamilyMembership[] @relation("SentRequests")   // é€ä¿¡ã—ãŸå®¶æ—ç”³è«‹
  receivedFamilyRequests FamilyMembership[] @relation("ReceivedRequests") // å—ä¿¡ã—ãŸå®¶æ—ç”³è«‹ (æ‰¿èªã™ã‚‹å´)
  familyMemberships     FamilyMembership[] @relation("UserMemberships")  // æ‰€å±ã™ã‚‹å®¶æ—ã‚°ãƒ«ãƒ¼ãƒ— (è‡ªåˆ†ãŒãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦æ‰¿èªã•ã‚ŒãŸã‚‚ã®)
  familyId      String?   @unique
  uploadedImages Image[]   // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒ
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --- ğŸ‘‡ New Models for pick-buyAI ---

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« (MVPã§ã¯Userãƒ¢ãƒ‡ãƒ«ã«çµ±åˆã‚‚å¯ã ãŒã€å°†æ¥çš„ãªæ‹¡å¼µã®ãŸã‚åˆ†é›¢ã‚‚æ¤œè¨)
model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique // Userãƒ¢ãƒ‡ãƒ«ã¨ã®ç´ä»˜ã‘ (ãƒ¦ãƒ‹ãƒ¼ã‚¯)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade) // Userã¸ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  bio       String?  // è‡ªå·±ç´¹ä»‹æ–‡ (ä»»æ„)
  birthDate DateTime? // ç”Ÿå¹´æœˆæ—¥ (ä»»æ„)
  // ãã®ä»–ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é …ç›®
}

// è‡ªåˆ†å²ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰
model Story {
  id            String       @id @default(cuid())
  title         String
  body          String       @db.Text
  eventDate     DateTime?
  lifeEventTag  LifeEventTag?
  visibility    Visibility   @default(PRIVATE)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  // Relations
  authorId      String
  author        User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  images        StoryImage[] // ç”»åƒã¨ã®å¤šå¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  
  @@map("stories")
}

// ç”»åƒç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
model Image {
  id            String       @id @default(cuid())
  filename      String       // ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å
  url           String       // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸URLï¼ˆS3/Cloudinaryç­‰ï¼‰
  thumbnailUrl  String?      // ã‚µãƒ ãƒã‚¤ãƒ«URL
  alt           String?      // ä»£æ›¿ãƒ†ã‚­ã‚¹ãƒˆ
  caption       String?      // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
  mimeType      String       // image/jpeg, image/pngç­‰
  fileSize      Int          // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆãƒã‚¤ãƒˆï¼‰
  width         Int?         // ç”»åƒå¹…
  height        Int?         // ç”»åƒé«˜ã•
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  // Relations
  uploaderId    String
  uploader      User         @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  stories       StoryImage[] // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¨ã®å¤šå¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  
  @@map("images")
}

// Story-Imageä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«
model StoryImage {
  id        String   @id @default(cuid())
  order     Int      @default(0) // ç”»åƒã®è¡¨ç¤ºé †åº
  createdAt DateTime @default(now())
  
  // Relations
  storyId   String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  imageId   String
  image     Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)
  
  @@unique([storyId, imageId])
  @@map("story_images")
}

// å®¶æ—ID (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™ºè¡Œã™ã‚‹ã‚‚ã®)
model Family {
  id             String   @id @default(cuid())
  familyIdString String   @unique @default(uuid()) // å®¶æ—ã«å…±æœ‰ã™ã‚‹ãŸã‚ã®ä¸€æ„ãªIDæ–‡å­—åˆ— (UUIDã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«)
  createdAt      DateTime @default(now())

  ownerId String @unique // ã“ã®å®¶æ—IDã‚’ç™ºè¡Œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  members FamilyMembership[] @relation("FamilyGroup") // ã“ã®å®¶æ—IDã«ç´ã¥ããƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—
}

// å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ— (ç”³è«‹ã¨æ‰¿èªã®çŠ¶æ…‹ã‚’ç®¡ç†)
model FamilyMembership {
  id        String   @id @default(cuid())
  status    FamilyMembershipStatus @default(PENDING) // ç”³è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (Enum)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ç”³è«‹è€… (ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ targetFamilyOwnerUserId ã®å®¶æ—ã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚ŠãŸã„)
  requesterId String
  requester   User   @relation("SentRequests", fields: [requesterId], references: [id], onDelete: Cascade)

  // ç”³è«‹å…ˆã®å®¶æ—IDã®ã‚ªãƒ¼ãƒŠãƒ¼ (ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰¿èª/æ‹’å¦ã™ã‚‹)
  targetFamilyOwnerId String
  targetFamilyOwner   User   @relation("ReceivedRequests", fields: [targetFamilyOwnerId], references: [id], onDelete: Cascade)

  // å®Ÿéš›ã«ç´ã¥ãFamily (æ‰¿èªã•ã‚ŒãŸå ´åˆ)
  // æ‰¿èªå¾Œã€requesterId ãŒ targetFamilyOwnerId ã® Family ã«æ‰€å±ã™ã‚‹ã€ã¨ã„ã†é–¢ä¿‚ã‚’ç¤ºã™
  // ã‚ˆã‚Šç›´æ¥çš„ãªé–¢ä¿‚æ€§ã‚’ç¤ºã™ãŸã‚ã«ã€Familyãƒ¢ãƒ‡ãƒ«ã¸ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚æŒã¤
  familyId String? // æ‰¿èªã•ã‚ŒãŸå ´åˆã«ã€å¯¾è±¡ã®Familyã®IDã‚’æ ¼ç´
  family   Family?  @relation("FamilyGroup", fields: [familyId], references: [id], onDelete:SetNull)

  // æ‰¿èªã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãŸã‚ã€Userãƒ¢ãƒ‡ãƒ«ã«ã‚‚ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒã¤
  memberUserId String? // æ‰¿èªã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID (requesterId ã¨åŒã˜)
  memberUser   User?    @relation("UserMemberships", fields: [memberUserId], references: [id], onDelete:SetNull)

  @@unique([requesterId, targetFamilyOwnerId]) // åŒã˜çµ„ã¿åˆã‚ã›ã®ç”³è«‹ã¯1ã¤ã ã‘
}


// Enumå®šç¾©
enum LifeEventTag {
  BIRTH
  CHILDHOOD
  STUDENT_DAYS
  FIRST_JOB
  CAREER_CHANGE
  MARRIAGE
  CHILDBIRTH
  PARENTING
  HOBBY
  TRAVEL
  TURNING_POINT
  HEALTH
  OTHER
}

enum Visibility {
  PRIVATE     // è‡ªåˆ†ã®ã¿
  FAMILY_ONLY // å®¶æ—ã®ã¿
  // PUBLIC   // å…¨ä½“å…¬é–‹ (å°†æ¥ã®æ‹¡å¼µ)
}

enum FamilyMembershipStatus {
  PENDING   // ç”³è«‹ä¸­
  APPROVED  // æ‰¿èªæ¸ˆã¿
  REJECTED  // æ‹’å¦
  // BLOCKED // ãƒ–ãƒ­ãƒƒã‚¯ (å°†æ¥ã®æ‹¡å¼µ)
}